<form [x-loading]="formLoading()" [formGroup]="form" class="app-dialog-form" (ngSubmit)="save()">
  <h4 x-dialog-title class="title">
    {{ id() ? ('$prompt.edit' | xI18n) : ('$prompt.add' | xI18n) }}
  </h4>
  <x-button x-dialog-close class="close" icon="fto-x" size="large" flat text></x-button>
  <div x-dialog-content class="content attrs">
    <div class="item required">
      <label>{{ '$prompt.name' | xI18n }}</label>
      <x-input formControlName="name" required></x-input>
    </div>
    <div class="item">
      <label>{{ '$base.description' | xI18n }}</label>
      <x-input formControlName="description"></x-input>
    </div>
    <div class="item required">
      <label>{{ '$prompt.useModel' | xI18n }}</label>
      <x-select
        [style.flex]="0.6"
        [data]="platformList()"
        formControlName="platform"
        [placeholder]="'$prompt.selectPlatform' | xI18n"
        required
      ></x-select>
      <x-select
        [data]="modelList()"
        formControlName="code"
        [placeholder]="'$prompt.selectCode' | xI18n"
        required
      ></x-select>
    </div>
    <div class="item">
      <label>{{ '$prompt.system' | xI18n }}</label>
      <app-editor
        class="editor"
        formControlName="system"
        [filename]="'markdown.md'"
        [style.height.rem]="8"
        [style.flex]="1"
        [options]="{
          placeholder: ('$prompt.systemPlaceholder' | xI18n),
          lineNumbers: 'off',
          minimap: { enabled: false }
        }"
      ></app-editor>
    </div>
    <div class="item required">
      <label>{{ '$prompt.prompt' | xI18n }}</label>
      <app-editor
        class="editor"
        formControlName="prompt"
        [filename]="'markdown.md'"
        [style.height.rem]="8"
        [style.flex]="1"
        [options]="{
          placeholder: ('$prompt.promptPlaceholder' | xI18n),
          lineNumbers: 'off',
          minimap: { enabled: false }
        }"
      ></app-editor>
    </div>

    @if (promptVars.controls.length > 0) {
      <div class="item attrs-table" formArrayName="promptVars">
        <label>{{ '$prompt.userVariables' | xI18n }}</label>
        <table [style.flex]="1">
          <thead>
            <tr>
              <th width="60">{{ '$base.index' | xI18n }}</th>
              <th width="180">{{ '$prompt.variable' | xI18n }}</th>
              <th>{{ '$prompt.value' | xI18n }}</th>
            </tr>
          </thead>
          <tbody>
            @for (control of promptVars.controls; track control) {
              <tr [formGroupName]="$index">
                <td class="index">{{ $index + 1 }}</td>
                <td>
                  <x-input formControlName="label"></x-input>
                </td>
                <td>
                  <x-input
                    formControlName="value"
                    [placeholder]="'$base.pleaseInput' | xI18n"
                    required
                  ></x-input>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <div class="item">
      <label></label>
      <ai-conversation
        [system]="form.get('system')?.value"
        [prompt]="promptValue"
        [platform]="form.get('platform')?.value"
        [model]="form.get('code')?.value"
        type="test"
      ></ai-conversation>
    </div>
  </div>
  <div x-dialog-actions align="center" class="actions">
    <x-button icon="fto-x" attrType="button" flat plain x-dialog-close>{{
      '$base.cancel' | xI18n
    }}</x-button>
    <x-button
      flat
      icon="fto-save"
      type="primary"
      attrType="submit"
      [loading]="saveLoading()"
      [disabled]="!form.valid"
      >{{ '$base.save' | xI18n }}</x-button
    >
  </div>
</form>
